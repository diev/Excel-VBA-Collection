# README #

Формат DBF, конечно, давно уже умер, но Федеральные службы РФ все еще охотно его используют. Например, ФСФМ (ФинМониторинг) требует отправлять ему файлы "в формате DBF", где 244 поля, и некоторые из них - типа C 254. Большинство древних утилиток для обработки DBF сходят с ума от таких объемов, а Excel никогда не сохранял требуемую структуру, более того - еще и даты часто коверкает.

В итоге написана эта программа для ручной щадящей обработки DBF. Вернее, здесь целая [коллекция](https://bitbucket.org/dievdo/excel-vba-collection/src) разных макросов для VBA Excel (система Банк-Клиент была написана на нем когда-то), которые еще на что-то годятся, гибко обрабатывая типично русские превратности (типа суммы с разделителями любого вида, а не только того, что жестко задан в системе, да еще зависит от текущей языковой раскладки!).

Вы можете взять готовый файл XLS из [Downloads](https://bitbucket.org/dievdo/excel-vba-collection/downloads), а при запуске разрешить макросы. Если боитесь запускать чужие макросы (и это правильно!) - открывайте редактор VBA и импортируйте исходные тексты (здесь они все в кодировке UTF-8):

#### Microsoft Excel Objects ####
* ЭтаКнига.cls - всего две функции: добавить меню при загрузке Workbook и убрать его по ее закрытию

#### Modules ####
* Base36.bas - работа с 36-ричными числами, популярными в Банке России
* Bytes.bas - работа с байтами - для CWinDos
* ChkData.bas - правила логического контроля настраивать здесь
* CWinDos.bas - ручная перекодировка 1251-866 с псевдографикой и фишками ЦБ
* DBF3x.bas - ручная работа в файлами DBF версии 3, загрузка и раскраска их, сохранение с заданной структурой
* Export.bas - пути экспорта
* KeyValue.bas - вычисления ключа счета, ИНН
* Main.bas - начальные инициализации, действия по завершении
* MenuBar.bas - пункты меню
* MiscFiles.bas - есть ли файл на диске, выбор файла и т.п.
* MsgBoxes.bas - разные красивые диалоги
* Printf.bas - аналог функции из языка Си
* RuSumStr.bas - чтение суммы в любом формате, сумма прописью - для платежек
* SheetUtils.bas - набросок макроса для сокращенной печати
* StrFiles.bas - работа с именами файловой системы
* StrUtils.bas - работа со строками
* TextFile.bas - работа с текстовыми файлами

#### Class Modules ####
* CApp.cls - класс приложения

## Как использовать ##

Раньше эта программа добавляла свою полосочку с пунктами-кнопочками меню, и все было замечательно. Затем Microsoft изобрела новый Ribbon, и эта пользовательская менюшечка оказалась задвинута ими подальше - ищите в меню "Надстройки". Переделывать под Ribbon уже не хочется - там все уже не так просто.

Если в ячейке A1 есть имя файла, при нажатии кнопки "Загрузить" - будет загружен именно этот файл. Если ячейка пуста - будет диалог выбора файла. При сохранении - аналогично. Файлы подразумеваются структуры DBF!

Одна из строк - структура DBF-файла из следующих столбцов-полей: "<Название поля> <Тип поля><Размер поля>". Название отделяется от остального пробелом. Тип и размер - или Вы знаете, о чем речь, или это есть в документации по заполнению отчетности. Таким образом, Вы можете прочитать любой DBF-файл (без MEMO-полей), создать новый или сохранить с новой структурой.

Данные Вы можете копировать и вставлять какие угодно. Сохранение будет происходить в соответствии с указанной выше строкой описания структуры.

Попутно эта программа (и это основная ее нынешняя функция) проверяет данные по некоему набору логических правил, сильно облегчая жизнь отделу финмониторинга - даже в условиях существования других покупных монстров, которые именно эти-то правила и пропускают мимо.

Все прочие исходные файлы, уже никак не относящиеся к этой задаче убраны в папку BClient - на случай, если понадобится еще что-то из наработанного ранее.